<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chevron App</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --tg-theme-bg-color: var(--tg-theme-bg-color, #ffffff);
            --tg-theme-text-color: var(--tg-theme-text-color, #000000);
            --tg-theme-button-color: var(--tg-theme-button-color, #3390ec);
            --tg-theme-button-text-color: var(--tg-theme-button-text-color, #ffffff);
            --tg-theme-hint-color: var(--tg-theme-hint-color, #999999);
            --tg-theme-secondary-bg-color: var(--tg-theme-secondary-bg-color, #f1f1f1);
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--tg-theme-bg-color);
            color: var(--tg-theme-text-color);
            margin: 0;
            padding: 15px;
            box-sizing: border-box;
        }
        .header {
            text-align: center;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--tg-theme-hint-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .header h1 {
            margin: 0;
            flex-grow: 1;
            text-align: center;
        }
        #logout-btn {
            padding: 5px 10px;
            border-radius: 5px;
            border: 1px solid var(--tg-theme-hint-color);
            cursor: pointer;
            background: var(--tg-theme-secondary-bg-color);
            color: var(--tg-theme-text-color);
        }
        .balance-card {
            background-color: var(--tg-theme-button-color);
            color: var(--tg-theme-button-text-color);
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            margin: 20px 0;
        }
        .balance-card h2 { margin: 0; font-size: 1.2em; }
        .balance-card #balance-amount { font-size: 2em; font-weight: bold; }
        .package-list h2 { margin-bottom: 15px; }
        .package-card {
            background-color: var(--tg-theme-secondary-bg-color);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .package-card h3 { margin-top: 0; }
        .details p { margin: 5px 0; color: var(--tg-theme-hint-color); }
        .details span { font-weight: bold; color: var(--tg-theme-text-color); }
        .timer {
            font-size: 1.5em; font-weight: bold; color: var(--tg-theme-button-color);
            text-align: center; margin: 15px 0;
        }
        .receive-btn {
            width: 100%; padding: 15px; font-size: 1em; font-weight: bold;
            border: none; border-radius: 8px; background-color: var(--tg-theme-button-color);
            color: var(--tg-theme-button-text-color); cursor: pointer;
        }
        .receive-btn:disabled {
            background-color: var(--tg-theme-hint-color); cursor: not-allowed;
        }
        .loader { text-align: center; padding: 20px; font-size: 1.2em; color: var(--tg-theme-hint-color); }
    </style>
</head>
<body>
    <header class="header">
        <div style="width: 60px;"></div> <!-- Spacer -->
        <h1>Chevron App</h1>
        <button id="logout-btn">Logout</button>
    </header>

    <main>
        <div id="app-content" style="display: none;">
            <div class="balance-card">
                <h2>Your Current Balance</h2>
                <p id="balance-amount">$0.00</p>
            </div>
            <section class="package-list">
                <h2>Your Active Packages</h2>
                <div id="packages-container"></div>
            </section>
        </div>
        <div id="main-loader" class="loader">Loading your data...</div>
    </main>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>

    <script>
        // --- PASTE YOUR FIREBASE CONFIGURATION HERE ---
        const firebaseConfig = {

  apiKey: "AIzaSyDVfH3eqx2vDrLfxAzNv8b0-_siZ6XxI5s",

  authDomain: "chevron-bot.firebaseapp.com",

  databaseURL: "https://chevron-bot-default-rtdb.firebaseio.com",

  projectId: "chevron-bot",

  storageBucket: "chevron-bot.firebasestorage.app",

  messagingSenderId: "131795679177",

  appId: "1:131795679177:web:3a5d9a3f640f5a30a61a18"

};
        // --- END OF FIREBASE CONFIG ---

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        const tg = window.Telegram.WebApp;
        tg.ready();

        const balanceAmountEl = document.getElementById('balance-amount');
        const packagesContainer = document.getElementById('packages-container');
        const logoutBtn = document.getElementById('logout-btn');
        const appContent = document.getElementById('app-content');
        const mainLoader = document.getElementById('main-loader');

        auth.onAuthStateChanged(user => {
            if (user) {
                mainLoader.style.display = 'none';
                appContent.style.display = 'block';
                main(user.uid);
            } else {
                window.location.replace('login.html');
            }
        });

        logoutBtn.addEventListener('click', () => {
            auth.signOut();
        });

        function main(userId) {
            fetchAndDisplayUserData(userId);
        }

        function fetchAndDisplayUserData(userId) {
            db.collection('users').doc(userId).onSnapshot(doc => {
                if (doc.exists) {
                    balanceAmountEl.innerText = `$${doc.data().balance.toFixed(2)}`;
                }
            });

            db.collection('investments').where('userId', '==', userId).onSnapshot(querySnapshot => {
                if (querySnapshot.empty) {
                    packagesContainer.innerHTML = '<div class="loader">You have no active packages.</div>';
                    return;
                }
                packagesContainer.innerHTML = '';
                querySnapshot.forEach(doc => {
                    const investment = doc.data();
                    investment.id = doc.id;
                    createPackageCard(investment);
                });
            });
        }

        function createPackageCard(investment) {
            const card = document.createElement('div');
            card.className = 'package-card';
            card.innerHTML = `
                <h3>${investment.packageName}</h3>
                <div class="details">
                    <p>Investment: <span>$${investment.investmentAmount}</span></p>
                    <p>Daily Commission: <span>$${investment.commissionAmount}</span></p>
                </div>
                <div class="timer" id="timer-${investment.id}">--:--:--</div>
                <button class="receive-btn" id="btn-${investment.id}" disabled>Receive Commission</button>
            `;
            packagesContainer.appendChild(card);
            startTimer(investment);
            document.getElementById(`btn-${investment.id}`).addEventListener('click', () => collectCommission(investment.id));
        }

        function startTimer(investment) {
            const timerEl = document.getElementById(`timer-${investment.id}`);
            const btnEl = document.getElementById(`btn-${investment.id}`);
            if (!investment.lastCollectionTimestamp) return;
            const targetTime = investment.lastCollectionTimestamp.toDate().getTime() + (24 * 60 * 60 * 1000);

            const interval = setInterval(() => {
                const distance = targetTime - new Date().getTime();
                if (distance <= 0) {
                    clearInterval(interval);
                    timerEl.innerText = "Ready to Collect!";
                    btnEl.disabled = false;
                    return;
                }
                const hours = Math.floor(distance / (1000 * 60 * 60));
                const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((distance % (1000 * 60)) / 1000);
                timerEl.innerText = `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
                btnEl.disabled = true;
            }, 1000);
        }

        async function collectCommission(investmentId) {
            const btnEl = document.getElementById(`btn-${investmentId}`);
            btnEl.disabled = true;
            btnEl.innerText = "Processing...";
            // This is a placeholder. You need to call your Firebase Cloud Function here.
            alert(`This is a demo. In a real app, clicking this would securely call a server function to grant commission.`);
            setTimeout(() => { btnEl.innerText = "Receive Commission"; }, 2000);
        }
    </script>
</body>
</html>